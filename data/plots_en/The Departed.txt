In the 1980s in Boston, Irish Mob boss Frank Costello introduces himself to a young Colin Sullivan. 
Many years later, Sullivan has been groomed as a spy inside the Massachusetts State Police (MSP) and joins the Special Investigation Unit (SIU). Another police academy recruit, Billy Costigan, is selected by Captain Queenan and Sergeant Dignam to go undercover as a criminal.
Costigan serves a term in prison to set up his cover and further commits a series of crimes. Sullivan begins dating Madolyn Madden, a psychiatrist. Costigan draws the attention of Costello, who later recruits Costigan into his organization. Over the next year, Costigan becomes increasingly involved in the organization. His mental state declines but Queenan and Dignam convince him to continue. Costigan begins having appointments with Madolyn.
The MSP and Costello realize there is a mole in their respective organizations and task Costigan and Sullivan to find them. Meanwhile, Costigan learns that Costello is a protected FBI informant. Costigan shares his discovery with Queenan. Costigan and Madolyn have an affair.
One night, Costigan follows Costello into an adult theater and witnesses him giving Sullivan an envelope containing information of his crew. Costigan is instructed to get a visual ID of Sullivan but he is unable to get a good look at his face. When Sullivan realizes that he is being followed, he accidentally stabs a man and flees. Queenan advises Sullivan to follow Costello to find the MSP mole. Costigan calls Queenan and sets up a meeting to end the undercover operation, but Sullivan has Queenan followed, lying to the other officers that Queenan may be the spy. Sullivan also calls in Costello's gang to the meeting location.
When Costello's men arrive, Queenan helps Costigan escape before being thrown from the building to his death. This causes a firefight between police and Costello's men. Angered by Queenan's murder, Dignam attacks Sullivan and is suspended. Timothy Delahunt, one of Costello's henchmen who was wounded in the gunfight, tells Costigan that he knows he is the rat before he succumbs to his wounds. Sullivan looks through Queenan's belongings and learns that Costello is an FBI informant after reading Queenan's notebook. A news report reveals that Delahunt was an undercover officer for the Boston Police Department, but Costello suspects the police department made up the claim so he would stop looking for the mole. Deciding to turn on him, Sullivan directs the MSP to tail Costello, and a gunfight erupts, killing most of Costello's crew. Sullivan confronts a wounded Costello, who admits to being an FBI informant. They exchange gunfire, and Sullivan kills him.
His assignment finished, Costigan goes to Sullivan to reveal his undercover status, still unaware of the other's true identity. After Sullivan goes to another room, Costigan notices the same envelope from the theater on his desk. Costigan realize that Sullivan was Costello's mole, and escapes. Shortly after, Sullivan returns to find Costigan gone, and realizes that he now knows his true identity. He deletes Costigan's records from police computers. Costigan visits Madolyn, who has revealed that she's pregnant to Sullivan but not to Costigan knowing that Sullivan may not be the father, and hands her an envelope, instructing her to open it if something happens to him. She receives a envelope in the mail from Costigan. Inside is a CD of Costello's recorded conversations with Sullivan. Scared that Costigan has revealed their affair, she listens to the taped conversations and leaves Sullivan. Costigan arranges to meet Sullivan on the rooftop of the building, where Queenan was killed, then arrests him. Costigan calls Trooper Brown, an acquaintance from the police academy, but Brown pulls a gun on Costigan when he arrives, unsure who is telling the truth.
Costigan says that he has evidence tying Sullivan to Costello, and Brown lets him go down the elevator. Upon reaching the lobby, Costigan and Brown are killed by Trooper Barrigan, a friend of Sullivan's who reveals himself to be another spy working for Costello. Sullivan shoots Barrigan dead, allowing him to out Barrigan as the mole while removing suspicion from himself.
At Costigan's funeral, Sullivan and Madolyn stand by his grave. As Madolyn silently cries, Sullivan realizes that they were involved. He attempts to talk to her, but she ignores him. When Sullivan arrives home, Dignam is waiting for him inside and shoots him in the head before he leaves.